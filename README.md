# OrthoPhyl
## (previously OrthoPhylo...OrthoPhyl sounds better)
### Developed at Los Alamos National Labs (LANL - C22064)
#### Written by Earl Middlbrook with input from Robab Katani at Penn State and Jeanne Fair at LANL.
#### The software is available through a GLPv3 open source licence. 
####
#### This software is designed to generate phylogenetic trees from bacterial genome assemblies. While many methods use whole genome alignments to generate informative sites to base tress on, OrthoPhyl annotates bacterial genes, identifies orthologous sequences, aligns related proteins to inform transcript alignments, then builds species trees with two methods. The first is a conventional gene concatenation and ML tree estemation method. The second attempts to reconcile gene trees with a unified species tree using quartets (ASTRAL). Both methods allow filtering of gene lists on number of species represented, length, and gappiness in order to tune signal-to-noise ratio for tree estimation. 
#### The main advantages of this software pipeline are three fold: 1) It extends the evolutionary distance input species can represent (over whole genome alignment and k-mer methods) while maintaining phylogenetic resolution, 2) this software is designed to be very user friendly, requiring mostly "conda" install-able dependencies and just a single input directory of genomes for which to reconstruct the evolutionary history (singularity and Docker images are now available) and 3) this pipleline is amenable to estimating trees for 1000s of bacterial genome assemblies. To handle large numbers of genomes, the pipline calculates a diversity-representing subset of genomes to run orthofinder on, then expands the OrthoGroups to all samples with HMM searches.

### More description: 
#### This software wraps many open source bioinformatic tools together with several custom programs. Genomes are annotated with Prodigal.  If a large number of genomes are to be analyzed, fastANI is used to estimate the pairwise genomic Average Nucleotide Identity (ANI) and then an OrthoPhyl function subsets the genomes to a minimal number which represent the diversity of the full set. Protein sequences from this subset (or full set for small numbers of genomes) are used as input for OrthoFinder to identify orthologous gene families. For the subset method, a HMM search, HMMER, is used to generalize the resulting orthogroup to the full data set. From there, orthogroup proteins are realigned with MAFFT, and these aignments are used to "codon" align the transcript sequences (generated by earlier annotation). These orthogroup transcript alignments are then trimmed (with TRIMAL) and filtered for strict single copy orthologs (SCO_strict) or SCOs found in at least X% of the input genomes (with X being tunable). Next, transcript alignmants are concatenated to generate super-maticies and used as input for species tree generation with either RAxML or fastTREE. Aditionally, gene trees are generated from the individual transcript alignments, which are used in gene tree to species tree estimation with ASTRAL.  

### Cleaning input genomes
#### The script OrthoPhyl/utils/gather_filter_asms.XX.sh was writen to streamiline aquiring all available assemblies for a specific taxon. It takes NCBI's taxID as and input (BrucellaTaxID=234). After the genomes are DL'd there are several simple genome filtering steps: length,N50,GC, etc. There are also a few more soficticated filtering methods: CheckM is used to assess completeness and contamination, while dedupe from BBmap is used to reduce duplicated contigs. 
#### It is absolutely imparative to clean up assemblies to get the best results from OrthoPhyl. For instance, when looking at the output for all Brucella accessions, checkM output shows many assemblies have duplicated "marker genes", if these are from falsely duplicated contigs in the asm, they will lead to removal of the ortholog group from both the strict SCO and relaxed SCO gene sets within the OrthoPhylo workflow. Furthermore, dedupe.sh (from bbmap) identifies many Duplicated or Contained contigs, some of them >100kb long. Again, if any of the duplicated contigs contain what would otherwise be SCOs, the SCOs will be removed. In essence, having duplicates poisons the analysis by severely reducing the number of Orthologs for downstream analysis. This problem is exacerbated by including 1) less curated assemblies (GenBank) and 2) the total number of assemblies fed to the analysis pipeline.

### What this software does not do: 
#### Generate trees that are ready for publication without parameter tuning or manual inspection. Reconstructing trees from whole genomes requires many many steps, all of which have parameters that will differ based on the input sequences. Some importent outputs too look at: input genomes quality (checkM output), assembly subset used for Ortholog model generation (assembly shortlist), number of strict/relaxed single copy orthologs (drops quickly with additional assemblies), phylogenetic signal for transcript alignments, missing data in alignments (per gene and concatenated alignments)...to name a few. #### This pipeline also does not robunstly compute SCOs (like BUSCOs). It grabs all the SCOs it can from a dataset, but does not do any modeling to ensure species tree-like behavior of the individual genes and also does not deal with paralogs at all.

# Getting Started
## Install
### Compatability and Dependencies
#### This workflow has been tested on a CentOS8 machine, but should be pretty portable. Testing is starting on diverse *nix systems. There will likely be some errors due to the wrapper having moderate bash complexity. Unfortunately fastANI seems to be incompatable with MacOS, so I will need to find an alternative before the pipeline can be run on that architecture.
### Dependencies
#### Either docker or Singularity to run a prebuilt container
```
singularity pull library://earlyevol/default/orthophyl
```
Congradulations! You can skip down to install testing!

#### OR install these dependencies with the instructions bellow.
+ prodigal 
+ orthofinder 
+ bbmap
+ fastTree*
+ hmmer
+ pal2nal
+ prodigal 
+ ete3
+ IQTree*
+ raxml*
+ trimal
+ parallel
+ catfasta2phyml
+ ASTRAL
+ fastANI
+ R
+ Alignment_Assessment

*depending on tree method used
### Conda/mamba installable dependencies
#### If you need to install conda or mamba we recomend mamba:
```
cd {path_to_downloads}
wget https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-Linux-x86_64.sh
bash Mambaforge-Linux-x86_64.sh
```
#### Follow on screen instructions
Set up auto initialize. If you don't, it is up to you to figure out how to make the script happy with your decision, you can also run:
```
mamba init bash
```

### Create conda environment and install dependencies
#### It is highly recomended that you create an separate environment for this install. Might take some time....
```
mamba create -n orthophyl --file orthophyl_env.XXX.txt
```
#### OR
```
mamba create -n orthophyl -c bioconda -c conda-forge \
git prodigal=2.6.3 orthofinder=2.5.4 \
bbmap=39.01 fasttree=2.1.11 hmmer=3.3.2 pal2nal=14.1 \
prodigal ete3 raxml=8.2.12 trimal=1.4.1 \
parallel=20160622 r-essentials=4.1
```
#### Sometimes R (r-essentials) can be a pain. If it is causing problems with the conda install, remove it and install manually:
#### Go to https://cran.r-project.org/mirrors.html and pick an appropriate mirror. Then chose the linux distro you are using, download package files, and follow install instructions.


#### To allow conda changes to take effect:
```
source ~/.bashrc
```
Alternatively, close and reopen terminal. 
#### To remove parallel's citation reminder (BUT DONT FORGET TO CITE!) run:
```
mamba activate orthophylo
parallel --citation
```
#### Test R install
```
Rscript --help
```

### Other dependencies
This reflects how I like to organize my machine, pick what works for you. The control_file.paths reflects this setup. If you choose to install the bellow packages in different locations, just change control_file.paths to reflect this.
```
Path_to_gits=~/gits
mkdir ~/$Path_to_gits
cd ~/$Path_to_gits/
git clone https://github.com/smirarab/ASTRAL.git
cd ASTRAL
unzip Astral.5.7.8.zip #change to curren version if needed

cd ~/$Path_to_gits/
git clone https://github.com/nylander/catfasta2phyml.git
git clone https://github.com/dportik/Alignment_Assessment.git
cd Alignment_Assessment/
# convert script to python3
2to3 -w Alignment_Assessment_v2.py 

cd ~/Downloads
wget https://github.com/ParBLiSS/FastANI/releases/download/v1.33/fastANI-Linux64-v1.33.zip
unzip fastANI-Linux64-v1.33.zip
# For macOS !!!!! NOT SOLVED !!!!!!
# git clone https://github.com/ParBLiSS/FastANI.git
# and follow install instructions. This has been a huge pain on my machine...not solved
mkdir ~/apps/
mv fastANI ~/apps/ # or anywhere else you would like to put it. Change control_file.required to reflect path
```

### Clone the Orthophylo repo, set up control files and run short* test

Cloning takes a minute because of the large test files
```
cd ~/$Path_to_gits/
git clone https://github.com/eamiddlebrook/OrthoPhyl.git
cd OrthoPhyl
```
### Edit control_file.paths to reflect system specific locations and conda environment name

## Test install
### Test Singularity container
```
singularity run OrthoPhyl.0.9.3.sif -T TESTER_chloroplast -s ./tester_chloroplast_output -t 4
```
### Test Manual install
#### To test 'conda activate' within OrthoPhyl, make sure the conda environment is not activated
```
mamba deactivate
``` 
### run Chloroplast test locally
#### Tested on RHEL 8.5 machine with Intel Core i7-8700 CPU and 16gb ram (~8 minute runtime using 3 cores)
```
bash OrthoPhyl.sh -T TESTER_chloroplast -t 3
```
There should be a directory created in OrthoPhyl/TESTER/Workflow_test.chloroplast$(date +%m-%d-%Y)
If the test was successful, there should be 4 species trees found in the FINAL_TREES

### run bigger test locally
####   this script takes about 20 hr to complete with 20 cores
####   Most of this is ML tree building
####   will make an artificial set of truncated genomes later
```
bash OrthoPhyl.sh -T TESTER -t 3
```
If the test was successful, there should be a file at "OrthoPhyl/TESTER.pass"
and "###### It looks like the install was successful ######" should be sent to stdout towards the end of the run


## Running OrthoPhyl on your data
```
USAGE: OrthoPhyl.sh -g Path_to_directory_of_assemblies -s directory_to_store_output 
# ALL arguments are optional if set in control_file.required
#   Many default parameters are set in control_file.defaults
Required:
-g	full path to genomes directiory
-s	full path to the main directory for output
Optional:
-t	threads to use [4]
-c	path to a control file with required variables and any optional ones to override defaults. 
        Will override values set on command line! [NULL]
-x	trimal paramerter string (in double "quotes") 
-r	flag to rerun orthofinder on the ANI_shorlist (true/[false])
-a	max number of genomes to run through OrthoFinder. 
        If more than this many assemblies are profided, a subset of genomes will be chosen for OrthoFinder to chew on [2]
-T	run test dataset, incompatable with -g|s (TESTER,TESTER_chloroplast)
-h	display a description and a super useful usage message
###############################################################\n
To run test datasets:
# Test of full bacterial genomes
bash OrthoPhyl.sh -T TESTER -t #threads
# Big test with ~100 orchid chloroplasts
bash OrthoPhyl.sh -T TESTER_chloroplast -t #threads
# When running through Singularity an output directory is required:
bash OrthoPhyl.sh -T TESTER -s output_dir -t #threads 

```


## known errors:
#### If you have special characters in you fasta file names
Filenames with special characters will likely make this workflow fail. As I encountered these characters, i will add fixes accordingly in Orthophyl.XX.sh, function SET_UP_DIR_STRUCTURE.
#### If the combination of fasta file name and contigs within are very long, 
...mafft will truncate the sequence names generated by prodigal. This will make the PAL2NAL module fail on many orthogroups. It manifests as a lot of cat commands failing during trimming because they cant find the transcript file PAL2NAL is suposed to spit out. This can be seen in the log file (in slurm_out). It's normally caused by very redundant sequence identifiers in the contig names. Can be fixed with something like this:
```
sed -i 's/REDUNDANT_STUFF/_/g' < SEQUENCE.fasta
```
#### If genomes are less than ~75% identity... 
FastANI doesnt calculate an ANI value for very divergent genomes. In this case my script ANI_picking.py assigns an ANI of 50 (hard coded) for these comparisons. This should not pose a problem if the number of clades with 75% divergence internally are ~= ANI_shortlist number. The goal of the ANI stuff is to find representetives of the evolutionaly breadth of the dataset, so missing representetives from some clades will likelly not affect the final result (there is a lot of filtering later on in the workflow).
I will implement a more robust ANI estimator soooon... 
#### If you get an error like: 
``` 
/cm/local/apps/slurm/var/spool/job49381/slurm_script: line 511: J % percent: division by 0 (error token is "percent") 
```
It means that an upstream process failed and the directory used to enumerate a loop is empty

I will attempt to make errors easier to track...

#### I have gotten an error with gather_filter_genomes when pulling extra genomes via wget:
```
dyld: Symbol not found: _libiconv_open
```
This appeared to be a problem with wget, which was resolved by updating through conda.

## Future modules:
+ DONE: add assembly filtering, now very incomplete assemblies will be used, so the number of strict single copy orthologs could be drastically reduced (maybe to zero). Filtering done with gather_filter_asm
+ DONE: Quantify phylogenetic info per gene (https://github.com/dportik/Alignment_Assessment.git)
+ Check genome assembly file not empty at start of Main pipeline....will crash pipe at Orthofinder run. This happened because of a file transfer mishap for me :( 
+ Test evolutionary models of genes with ete3. Then test GO enrichment, AMR, Virulence genes
+ Look at tree wide paralog numbers. Do GO analysis...
+ Identify HGT from Transcript alignments. HGTs specific to any group?
+ allow "protected assemblies" when filtering. Perhaps your favorite assembly is crap, but you really want it in the tree. A couple of bad assemblies shouldnt reduce the number of SCOs that much
+ allow usage of precomputed Orthogroup HMMs, build new models from hits, then grab novel orthogroups from the remaining protiens
+ Related to above: allow adding assemblies to pre-run pipeline. i.e. use precomputed hmms to identify orthologs, and add them to alignemnts and regenerate trees
+ allow users to pick which dataset to use for tree building (currently strict and relaxed are used). This would greatly reduce pipeline run time.
+ change how the list of OGs for HMM  searching is inumerated. Currently tries with OG that have be filtered out because of paralogs, then gets mad because there is no multifasta to align (doesnt change outcome, just messy)


## OrthoPhyl Citation:
### [Comming soon]
## Citations for dependencies
### If there are nested dependencies that I am missing citations for, please let me know
### [Comming soon]
+ prodigal 
+ orthofinder 
+ bbmap
+ fastTree*
+ hmmer
+ pal2nal
+ mafft
+ prodigal 
+ ete3
+ IQTree*
+ raxml*
+ trimal
+ parallel
+ catfasta2phyml
+ ASTRAL
+ fastANI
+ R
+ Alignment_Assessment
+ blast
+ scipy
+ numpy
+ muscle
+ mmseq2
+ mcl
+ fastme
+ diamond

